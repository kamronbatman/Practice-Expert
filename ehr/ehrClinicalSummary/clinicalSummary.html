<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Clinical Summary</title>
    <link rel="stylesheet" type="text/css" href="../../public/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../public/font-awesome-4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="./clinicalSummary.css">
  </head>
  <body>

    <div id="wrapper">
        <div id="top-bar">
          <button id="btnOptions" onclick="showOptions()"><i class="fa fa-bars"></i> Options</button>
          <span id="spanToolBar" style="display:none;">
            <button id="btnRefresh" onclick="refreshSummary()" class="btn btn-default"><i class="fa fa-refresh"></i> Refresh</button>
            <button id="btnPrintSummary" onclick="printSummary()"  class="btn btn-info" ><i class="fa fa-print"></i> Print</button>
            <button id="btnSendToPortal" onclick="sendToPortal()" class="btn btn-primary"><i class="fa fa-paper-plane"></i> Send To Portal</button> <!-- Viral: 02/02/2017 This feature is not implemented right now -->
          </span>
          <span id="spanLoading" style="margin-left: 10px; font-size:12px;"><i class="fa fa-refresh fa-spin"></i> Loading...</span>
          <span id="spanSending" style="margin-left: 10px; font-size:12px; display: none;"><i class="fa fa-refresh fa-spin"></i> Sending...</span>
        </div>
        <div id="side-nav">
            <div>
              <a href="javascript:void(0)" class="closebtn" onclick="closeOptionsNav()">&times;</a>
            </div>

            <div id="divSaveOptions" style="margin-top:30px; display:none">
                <div>
                  <button id="btnSaveOptions" onclick="saveOptions()" class="btn btn-warning" style="margin-left : 5px;"><i class="fa fa-save"></i> Save</button>
                </div>
                <hr style="margin-top: 5px;" />
            </div>
            <div>
              <div id="side-nav-options" style="margin-left : 15px;">
              </div>
            </div>
        </div>
        <div id="main">
          <div id="main-content">
          </div>
        </div>
    </div>


    <script>

        var remote = require('electron').remote;
        var nodeModulesPath = remote.getGlobal('nodeModulesPath');
        var appPath = remote.getGlobal('appPath');
      var $ = jQuery = require(nodeModulesPath + "jquery");
      var cmGlb = remote.getGlobal('cmGlb');

      var Handlebars = require(nodeModulesPath + 'handlebars');

      var _userId =   cmGlb.userId;
      var _patId =  cmGlb.patId; //'CLINTON';
      var _dateOfVisit = cmGlb.dateOfVisit; //'2016-09-14 10:13:00';
      var _dctId =  cmGlb.dctId ? cmGlb.dctId : '';


      var _email = cmGlb.patEmail ? cmGlb.patEmail : '';
      var _license = cmGlb.license ? cmGlb.license : '' ;

      var _firstName = cmGlb.firstName ? cmGlb.firstName : '' ; //'Viral';
      var _patientName =  cmGlb.patName ? cmGlb.patName : ''; //'Viral Mistry'

      console.log("User Id : "+_userId);
      console.log("PatId Id : "+_patId);
      console.log("Date Of Visit: "+_dateOfVisit);
      console.log("Dct Id : "+_dctId);

      console.log("Email : "+_email);
      console.log("License : " + _license);
      console.log("First Name : " + _firstName);
      console.log("Patient Name : " + _patientName);
      console.log(cmGlb.isSqlAzure);



      var clinicalSummarySql = require(appPath + "/ehr/ehrClinicalSummary/clinicalSummarySql.js");

      $(document).ready(function () {

         getClinicalSummary();
      });

      function refreshSummary() {
        getClinicalSummary();
      }

      function showOptions() {

            $( "#side-nav-options" ).empty();
            document.getElementById("side-nav").style.width = "250px";
            document.getElementById("top-bar").style.marginLeft = "250px";
            document.getElementById("main").style.marginLeft = "250px";
            document.getElementById("divSaveOptions").style.display = "block";

            clinicalSummarySql.getOptions(_userId, function (err, record) {
                  if(err)
                  {
                    console.error(err);
                    alert("Error: Retrieving options list.");
                  }
                  else
                  {
                    //console.log(record);
                    if(record && record.length > 0)
                    {
                      var data = record[0];
                      for (var key in data)
                      {
                        if (data.hasOwnProperty(key))
                        {
                          //console.log(key + " -> " + data[key].value);
                          if(data[key].value)
                          {

                              $( "#side-nav-options" ).append("<label style='cursor: pointer'><input type='checkbox' id='"+key+"' name='"+key+"'  checked />&nbsp;" + formatKeyName(key) +"</label><br />" );
                          }
                          else
                          {
                              $( "#side-nav-options" ).append("<label style='cursor: pointer'><input type='checkbox' id='"+key+"' name='"+key+"'  />&nbsp;" + formatKeyName(key) +"</label><br />" );
                          }

                        }


                      }

                    }
                    else
                    {
                      console.log(record);
                      alert("No record found for this user in options table.");
                    }
                  }
            });
      }

      function closeOptionsNav() {

        $( "#side-nav-options" ).empty();
        document.getElementById("side-nav").style.width = "0px";
        document.getElementById("top-bar").style.marginLeft = "0px";
        document.getElementById("main").style.marginLeft = "0px";
        document.getElementById("divSaveOptions").style.display = "none";

      }

      function saveOptions() {
        //alert("Save!");
        var elements = document.getElementById("side-nav-options").children;
        //console.log(elements);
        var saveData = {};

        if(elements && elements.length > 0)
        {
          for(var i = 0; i < elements.length; i++)
          {

              if(elements[i].nodeName == "LABEL")
              {
                var subElements = elements[i].children;
                if(subElements && subElements.length > 0)
                {
                  for(var j = 0; j < subElements.length; j++)
                  {
                    if(subElements[j].nodeName == "INPUT")
                    {
                      //console.log(subElements[j].id);
                      //console.log(subElements[j].checked);
                        //var checkBox
                      saveData[subElements[j].id] = subElements[j].checked;


                    }
                  }
                }

              }
          }

          $("#btnSaveOptions").css({"opacity":"0.65", "cursor":"not-allowed"});
          //Save Options
          clinicalSummarySql.saveOptions(_userId, saveData, function (err, record) {

                if(err)
                {
                    console.error(err);
                    alert("Error: Saving options list.");
                }
                else
                {
                  //console.log(record);
                  var isFromSaveOption = true;
                  getClinicalSummary(isFromSaveOption);
                }
            });

        }

      }

      function printSummary() {

        var restorePage = document.body.innerHTML;
        var printContent = document.getElementById("main").innerHTML;
        document.body.innerHTML = printContent;

        //directly print to printer
        //window.print();

        //Print to pdf
        const fs = require('fs');
        const os = require('os');
        const path = require('path');
        const electron = require('electron');
        const BrowserWindow = electron.remote.BrowserWindow;
        const shell = electron.shell;
        const win = BrowserWindow.getFocusedWindow();

        var dateTimeSecUid = stringDateTimeUniqueNumber();

        const pdfPath = path.join(os.tmpdir(), 'printSummary_'+ dateTimeSecUid +'.pdf');

        //console.log(pdfPath);

        // Use default printing options
        win.webContents.printToPDF({marginsType: 0}, function (error, data) {

              if (error)
              {
                console.error(error);
                document.body.innerHTML = restorePage;
                alert("Error: While printing document (Print to PDF.)");
              }
              else {
                fs.writeFile(pdfPath, data, function (error) {

                  if (error) {
                    alert("Error: While printing document (Print to PDF Creating File.)");
                    console.error(error);
                  }
                  else {
                    shell.openItem(pdfPath);
                  }

                  document.body.innerHTML = restorePage;
                });
              }

        });

      }


      function sendToPortal() {

        if(!_email)
        {
          alert("Patient doesn't have email.");
          return;
        }

        var restorePage = document.body.innerHTML;
        var printContent = document.getElementById("main").innerHTML;
        document.body.innerHTML = printContent;

        const electron = require('electron');
        const BrowserWindow = electron.remote.BrowserWindow;
        const win = BrowserWindow.getFocusedWindow();


        win.webContents.printToPDF({}, function (error, data) {


              document.body.innerHTML = restorePage;

              if (error) {
                console.log(error);
                alert("Error Sending To Portal (Creating Pdf Data)");
              }
              else {

                $("#spanSending").show();
                $("#spanToolBar").css("display", "none");

                var img = data;

                clinicalSummarySql.sendSummaryToPortal(_patId, _userId, _dateOfVisit, _dctId, img, function(err, record){

                      if(err)
                      {
                        $("#spanSending").hide();
                        $("#spanToolBar").css("display", "inline-block");

                        console.error(err);
                        alert("Error: Sending to Portal -> Saving to Pat-Notes.");
                      }
                      else
                      {

                        clinicalSummarySql.sendEmailToPatient(_email, _license, _firstName, _patientName, function(err1, info){

                          $("#spanSending").hide();
                          $("#spanToolBar").css("display", "inline-block");

                            if(err1)
                            {
                              console.error(err1);
                              alert('Summary Sent to Portal Successfully, but unalbe to send an email to patient to notify him/her');
                            }
                            else
                            {
                              //console.log(info);
                              alert('Summary Sent to Portal Successfully.');
                            }

                          });
                      }

                });

              }
          });

      }


      function getClinicalSummary(isFromSaveOption) {

          $("#spanLoading").show();
          $("#spanToolBar").css("display", "none");

          clinicalSummarySql.getClinicalSummaryTemplate(function(err, record){


              if(err)
              {
                $("#spanLoading").hide();
                console.error(err);
                alert("Error: Retrieving Clinical Summary Template.");
              }
              else
              {
                //console.log(record);
                if(record && record.length > 0)
                {
                      var template =  record[0].FORMHTML.value; //record[0].FORMHTML.value; // $("#tmpTemplate").html()
                      var renderer = Handlebars.compile(template);

                      clinicalSummarySql.getClinicalSummaryData(_patId, _dateOfVisit, _license, _userId, function (err1, record1) {

                            $("#spanLoading").hide();
                            $("#spanToolBar").css("display", "inline-block");

                            if(isFromSaveOption){
                              $("#btnSaveOptions").css({"opacity":"", "cursor":""});
                              document.getElementById("side-nav").style.width = "0px";
                              document.getElementById("top-bar").style.marginLeft = "0px";
                              document.getElementById("main").style.marginLeft = "0px";
                                document.getElementById("divSaveOptions").style.display = "none";
                              $( "#side-nav-options" ).empty();
                            }


                            if(err1)
                            {
                              console.error(err1);
                              alert("Error: Retrieving Clinical Summary Data.");
                            }
                            else
                            {
                              var result = renderer(createOneJsonObjFromRecord(record1));
                              var element = document.getElementById("main-content");
                              element.innerHTML = result;
                            }

                      });
                }
                else
                {
                  console.log(record);
                  alert("No record found in xrxForms_List table for Clinical Summary.");
                }

              }

          });

      }

      function createOneJsonObjFromRecord(record) {

            var data = {};

            data["dateOfVisit"] = stringFormatedDate(_dateOfVisit);
            data["todaysDate"] = stringFormatedDate();

            for(i = 0; i < record.length; i++)
            {

                //console.log(record[i]["TAG"].value);
                if (record[i]["ORDER1"].value == "30") { //fuVisit

                    if (!fuVisit)
                    {
                      var fuVisit = {
                          caption: 'F/U Visit:',
                          fuVisits: []
                      };
                      data["fuVisit"] = fuVisit;
                    }

                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objfuVisits = {};
                      objfuVisits["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objfuVisits["value"] = record[i]["TEXT3"].value;
                      fuVisit.fuVisits.push(objfuVisits);
                    }
                }
                else if(record[i]["ORDER1"].value == "40") { //hpi

                  if (!hpi)
                  {
                    var hpi = {
                        caption: 'History of Present Illness:',
                        hpis: []
                    };
                    data["hpi"] = hpi;
                  }

                  if(isOdd(record[i]["ORDER2"].value))
                  {
                    var objHPIs = {};
                    objHPIs["keyName"] = record[i]["TEXT1"].value;
                  }
                  else
                  {
                    objHPIs["value"] = record[i]["TEXT2"].value;
                    hpi.hpis.push(objHPIs);
                  }
                }
                else if(record[i]["ORDER1"].value == "50") { //medicalHistory

                    if (!medicalHistory)
                    {
                      var medicalHistory = {
                          caption: 'Medical History:',
                          medicalHistories: []
                      };
                      data["medicalHistory"] = medicalHistory;
                    }


                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objMedicalHistories = {};
                      objMedicalHistories["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objMedicalHistories["value"] = record[i]["TEXT2"].value;
                      medicalHistory.medicalHistories.push(objMedicalHistories);
                    }

                }
                else if(record[i]["ORDER1"].value == "60") { //surgicalHistory
                    if (!surgicalHistory)
                    {
                      var surgicalHistory = {
                          caption: 'Surgical History:',
                          surgicalHistories: []
                      };
                      data["surgicalHistory"] = surgicalHistory;
                    }


                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objSurgicalHistories = {};
                      objSurgicalHistories["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objSurgicalHistories["value"] = record[i]["TEXT2"].value;
                      surgicalHistory.surgicalHistories.push(objSurgicalHistories);
                    }
                }
                else if(record[i]["ORDER1"].value == "70") { //healthMaintenance
                    if (!healthMaintenance)
                    {
                      var healthMaintenance = {
                          caption: 'Health Maintenance:',
                          healthMaintenanceList: []
                      };
                      data["healthMaintenance"] = healthMaintenance;
                    }

                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objhealthMaintenanceList = {};
                      objhealthMaintenanceList["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objhealthMaintenanceList["value"] = record[i]["TEXT2"].value;
                      healthMaintenance.healthMaintenanceList.push(objhealthMaintenanceList);
                    }
                }
                else if(record[i]["ORDER1"].value == "80") { //pediatricHistory
                    if (!pediatricHistory)
                    {
                      var pediatricHistory = {
                          caption: 'Pediatric History:',
                          pediatricHistoryList: []
                      };
                      data["pediatricHistory"] = pediatricHistory;
                    }


                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objPediatricHistoryList = {};
                      objPediatricHistoryList["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objPediatricHistoryList["value"] = record[i]["TEXT2"].value;
                      pediatricHistory.pediatricHistoryList.push(objPediatricHistoryList);
                    }
                }
                else if(record[i]["ORDER1"].value == "90") { //psychiatricHistory
                    if (!psychiatricHistory)
                    {
                      var psychiatricHistory = {
                          caption: 'Psychiatric History:',
                          psychiatricHistoryList: []
                      };
                      data["psychiatricHistory"] = psychiatricHistory;
                    }


                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objPsychiatricHistoryList = {};
                      objPsychiatricHistoryList["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objPsychiatricHistoryList["value"] = record[i]["TEXT2"].value;
                      psychiatricHistory.psychiatricHistoryList.push(objPsychiatricHistoryList);
                    }
                }
                else if(record[i]["ORDER1"].value == "100") { //vascularHistory
                    if (!vascularHistory)
                    {
                      var vascularHistory = {
                          caption: 'Vascular History:',
                          vascularHistoryList: []
                      };
                      data["vascularHistory"] = vascularHistory;
                    }

                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objVascularHistoryList = {};
                      objVascularHistoryList["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objVascularHistoryList["value"] = record[i]["TEXT2"].value;
                      vascularHistory.vascularHistoryList.push(objVascularHistoryList);
                    }
                }
                else if(record[i]["ORDER1"].value == "110") { //obstetricalHistory
                    if (!obstetricalHistory)
                    {
                      var obstetricalHistory = {
                          caption: 'Obstetrical History:',
                          obstetricalHistoryList: []
                      };
                      data["obstetricalHistory"] = obstetricalHistory;
                    }

                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objObstetricalHistoryList = {};
                      objObstetricalHistoryList["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objObstetricalHistoryList["value"] = record[i]["TEXT2"].value;
                      obstetricalHistory.obstetricalHistoryList.push(objObstetricalHistoryList);
                    }
                }
                else if(record[i]["ORDER1"].value == "120") { //allergy

                    if(!allergy)
                    {
                      var allergy = {
                        caption : 'Allergies:',
                        allergies : []
                      };
                      data["allergy"] = allergy;
                    }

                    var textAllergy = record[i]["TEXT2"].value;
                    allergy.allergies.push(textAllergy);

                }
                else if(record[i]["ORDER1"].value == "130") { //medicationHistory

                    if(!medicationHistory)
                    {
                      var medicationHistory = {
                        caption : 'Medication History:',
                        medicationHistoryList : []
                      };
                      data["medicationHistory"] = medicationHistory;
                    }

                    var textMedicationHistory = record[i]["TEXT2"].value;
                    medicationHistory.medicationHistoryList.push(textMedicationHistory);

                }
                else if(record[i]["ORDER1"].value == "150") { //familyHistory
                    if (!familyHistory)
                    {
                      var familyHistory = {
                          caption: 'Family History:',
                          familyHistoryList: []
                      };
                      data["familyHistory"] = familyHistory;
                    }

                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objFamilyHistoryList = {};
                      objFamilyHistoryList["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objFamilyHistoryList["value"] = record[i]["TEXT2"].value;
                      familyHistory.familyHistoryList.push(objFamilyHistoryList);
                    }
                }
                else if(record[i]["ORDER1"].value == "160") { //socialHistory
                    if (!socialHistory)
                    {
                      var socialHistory = {
                          caption: 'Social History:',
                          socialHistoryList: []
                      };
                      data["socialHistory"] = socialHistory;
                    }

                    if(isOdd(record[i]["ORDER2"].value))
                    {
                      var objSocialHistoryList = {};
                      objSocialHistoryList["keyName"] = record[i]["TEXT2"].value;
                    }
                    else
                    {
                      objSocialHistoryList["value"] = record[i]["TEXT2"].value;
                      socialHistory.socialHistoryList.push(objSocialHistoryList);
                    }
                }
                else if (record[i]["ORDER1"].value == "170" || record[i]["ORDER1"].value == "175") { //reviewOfSystem

                  if (!reviewOfSystem)
                  {
                    var reviewOfSystem = {
                        caption: 'Review Of System:',
                        reviewOfSystemList: []
                    };
                    data["reviewOfSystem"] = reviewOfSystem;
                  }

                  if(isOdd(record[i]["ORDER2"].value))
                  {
                    var objReviewOfSystemList = {};
                    objReviewOfSystemList["keyName"] = record[i]["TEXT2"].value;
                  }
                  else
                  {

                    if(record[i]["ORDER1"].value == "170")
                    {
                      objReviewOfSystemList["value"] = record[i]["TEXT3"].value;
                    }
                    else if(record[i]["ORDER1"].value == "175")
                    {
                      objReviewOfSystemList["value"] = record[i]["TEXT2"].value;
                    }

                    reviewOfSystem.reviewOfSystemList.push(objReviewOfSystemList);
                  }
                }
                else if (record[i]["ORDER1"].value == "190"){ //vitalSign
                    if (!vitalSign)
                    {
                      var vitalSign = {
                          caption: 'Vital Signs:',
                          text: record[i]["TEXT2"].value
                      };
                      data["vitalSign"] = vitalSign;
                    }
                }
                else if (record[i]["ORDER1"].value == "200"){ //narrative
                  if (!narrative)
                  {
                    var narrative = {
                        caption: 'Narrative',
                        text: record[i]["TEXT1"].value

                    };
                    data["narrative"] = narrative;
                  }
                }
                else if (record[i]["ORDER1"].value == "210") { //exam

                      if (!exam)
                      {
                        var exam = {
                            caption: 'Exam:',
                            exams: []
                        };
                        data["exam"] = exam;
                      }

                      if(isOdd(record[i]["ORDER2"].value))
                      {
                        var objExams = {};
                        objExams["keyName"] = record[i]["TEXT2"].value;
                      }
                      else
                      {
                        objExams["value"] = record[i]["TEXT3"].value;
                        exam.exams.push(objExams);
                      }

                }
                else if(record[i]["TAG"].value == "examSlitLamps") { //examSlitLamps

                  if(!examSlitLamps)
                  {
                    var examSlitLamps = {};
                    data["examSlitLamps"] = examSlitLamps;
                  }

                  var key = record[i]["TEXT1"].value;

                  if(key == "odGrade" || key == "odPTM" || key == "odPas") {

                    if(!odGradePTMPas)
                    {
                      var odGradePTMPas = {};
                      examSlitLamps["odGradePTMPas"] = odGradePTMPas;
                    }
                    odGradePTMPas[key] = record[i]["TEXT2"].value;

                  }
                  else if(key == "osGrade" || key == "osPTM" || key == "osPas") {

                    if(!osGradePTMPas)
                    {
                      var osGradePTMPas = {};
                      examSlitLamps["osGradePTMPas"] = osGradePTMPas;
                    }
                    osGradePTMPas[key] = record[i]["TEXT2"].value;
                  }
                  else if(key.startsWith("slit")) {
                    if(!slit)
                    {
                      var slit = {};
                      examSlitLamps["slit"] = slit;
                    }
                    slit[key] = record[i]["TEXT2"].value;
                  }
                  else if(key.startsWith("dilated") || key == "phenylephrine" || key == "tropicamide") {

                      if(!dilated)
                      {
                        var dilated = {};
                        examSlitLamps["dilated"] = dilated;
                      }
                      if(key.startsWith("dilatedOd") || key.startsWith("dilatedOs"))
                      {
                        if(!dilatedOdOs)
                        {
                          var dilatedOdOs = {};
                          dilated["dilatedOdOs"] = dilatedOdOs;
                        }
                        dilatedOdOs[key] = record[i]["TEXT2"].value;
                      }
                      else {
                        dilated[key] = record[i]["TEXT2"].value;
                      }
                  }
                  else {
                      examSlitLamps[key] = record[i]["TEXT2"].value;
                  }

                }
                else if(record[i]["TAG"].value == "examRefractions") { //examRefractions

                  if(!examRefractions)
                  {
                    var examRefractions = {};
                    data["examRefractions"] = examRefractions;
                  }

                  var orderNo = record[i]["ORDER1"].value.toString();
                  var key = record[i]["TEXT1"].value;

                  if(orderNo == "1000") {

                    if(!examRefractionsCaptionOne)
                    {
                      var examRefractionsCaptionOne = "";
                      examRefractionsCaptionOne = record[i]["TEXT2"].value;
                      examRefractions["examRefractionsCaptionOne"] = examRefractionsCaptionOne;
                    }
                  }
                  else if(orderNo == "2000") {

                    if(!examRefractionsCaptionTwo)
                    {
                      var examRefractionsCaptionTwo = "";
                      examRefractionsCaptionTwo = record[i]["TEXT2"].value;
                      examRefractions["examRefractionsCaptionTwo"] = examRefractionsCaptionTwo;
                    }
                  }
                  else if(orderNo == "3000") {

                      if(!examRefractionsCaptionThree)
                      {
                        var examRefractionsCaptionThree = "";
                        examRefractionsCaptionThree = record[i]["TEXT2"].value;
                        examRefractions["examRefractionsCaptionThree"] = examRefractionsCaptionThree;
                      }
                  }
                  else if(orderNo.startsWith("10")) {
                    if(!examRefractionsOne)
                    {
                      var examRefractionsOne = {};
                      examRefractions["examRefractionsOne"] = examRefractionsOne;
                    }
                    examRefractionsOne[key] = record[i]["TEXT2"].value;
                  }
                  else if(orderNo.startsWith("20")) {
                    if(!examRefractionsTwo)
                    {
                      var examRefractionsTwo = {};
                      examRefractions["examRefractionsTwo"] = examRefractionsTwo;
                    }
                    examRefractionsTwo[key] = record[i]["TEXT2"].value;
                  }
                  else if(orderNo.startsWith("30")) {
                    if(!examRefractionsThree)
                    {
                      var examRefractionsThree = {};
                      examRefractions["examRefractionsThree"] = examRefractionsThree;
                    }
                    examRefractionsThree[key] = record[i]["TEXT2"].value;
                  }
                }
                else if (record[i]["TAG"].value == "eyeWorkup230") { //eyeWorkup

                  if(!eyeWorkup)
                  {
                    var eyeWorkup = {};
                    data["eyeWorkup"] = eyeWorkup;
                  }

                  var orderNo = record[i]["ORDER1"].value.toString();

                  if(orderNo == "0")
                  {
                    if(!row0)
                    {
                      var row0 = {};
                      eyeWorkup["row0"] = row0;
                    }

                    var key = record[i]["TEXT1"].value;
                    row0[key] = record[i]["TEXT2"].value;
                  }
                  else if(orderNo == "1")
                  {
                    if(!row1)
                    {
                      var row1 = {};
                      eyeWorkup["row1"] = row1;
                    }

                    var key = record[i]["TEXT1"].value;
                    if(key.startsWith("distanceCorrected"))
                    {
                      if(!distanceCorrected)
                      {
                        var distanceCorrected = {};
                        row1["distanceCorrected"] = distanceCorrected;
                      }
                      distanceCorrected[key] = record[i]["TEXT2"].value;
                    }
                    if(key.startsWith("distanceUnCorrected"))
                    {
                      if(!distanceUnCorrected)
                      {
                        var distanceUnCorrected = {};
                        row1["distanceUnCorrected"] = distanceUnCorrected;
                      }
                      distanceUnCorrected[key] = record[i]["TEXT2"].value;
                    }
                    if(key.startsWith("nearCorrected"))
                    {
                      if(!nearCorrected)
                      {
                        var nearCorrected = {};
                        row1["nearCorrected"] = nearCorrected;
                      }
                      nearCorrected[key] = record[i]["TEXT2"].value;
                    }
                    if(key.startsWith("nearUnCorrected"))
                    {
                      if(!nearUnCorrected)
                      {
                        var nearUnCorrected = {};
                        row1["nearUnCorrected"] = nearUnCorrected;
                      }
                      nearUnCorrected[key] = record[i]["TEXT2"].value;
                    }
                  }
                  else if(orderNo == "2")
                  {
                    if(!row2)
                    {
                      var row2 = {};
                      eyeWorkup["row2"] = row2;
                    }

                    var key = record[i]["TEXT1"].value;
                    row2[key] = record[i]["TEXT2"].value;
                  }
                  else if(orderNo == "3")
                  {
                    if(!row3)
                    {
                      var row3 = {};
                      eyeWorkup["row3"] = row3;
                    }

                    var key = record[i]["TEXT1"].value;
                    //row3[key] = record[i]["TEXT2"].value;

                    if(key.endsWith("1"))
                    {
                      if(!intraocular1)
                      {
                        var intraocular1 = {};
                        row3["intraocular1"] = intraocular1;
                      }
                      intraocular1[key] = record[i]["TEXT2"].value;
                    }
                    else if(key.endsWith("2"))
                    {
                      if(!intraocular2)
                      {
                        var intraocular2 = {};
                        row3["intraocular2"] = intraocular2;
                      }
                      intraocular2[key] = record[i]["TEXT2"].value;

                    }



                  }
                  else if(orderNo == "4")
                  {
                    if(!row4)
                    {
                      var row4 = {};
                      eyeWorkup["row4"] = row4;
                    }

                    var key = record[i]["TEXT1"].value;
                    //row4[key] = record[i]["TEXT2"].value;

                    if(key.startsWith("amsler"))
                    {
                      if(!amsler)
                      {
                        var amsler = {};
                        row4["amsler"] = amsler;
                      }
                      amsler[key] = record[i]["TEXT2"].value;
                    }
                    if(key.startsWith("color"))
                    {
                      if(!color)
                      {
                        var color = {};
                        row4["color"] = color;
                      }
                      color[key] = record[i]["TEXT2"].value;
                    }
                    if(key.startsWith("glaucoma"))
                    {
                      if(!glaucoma)
                      {
                        var glaucoma = {};
                        row4["glaucoma"] = glaucoma;
                      }
                      glaucoma[key] = record[i]["TEXT2"].value;
                    }
                  }


                }
                else if (record[i]["ORDER1"].value == "260") { //diagnosticStudy

                      if (!diagnosticStudy)
                      {
                        var diagnosticStudy = {
                            caption: 'Diagnostic Study:',
                            diagnosticStudyList: []
                        };
                        data["diagnosticStudy"] = diagnosticStudy;
                      }


                      if(isOdd(record[i]["ORDER2"].value))
                      {
                        var objDiagnosticStudyList = {};
                        objDiagnosticStudyList["keyName"] = record[i]["TEXT2"].value;
                      }
                      else
                      {
                        objDiagnosticStudyList["value"] = record[i]["TEXT2"].value;
                        diagnosticStudy.diagnosticStudyList.push(objDiagnosticStudyList);
                      }
                }
                else if (record[i]["ORDER1"].value == "270") { //assessmentNote

                    if (!assessmentNote)
                    {
                      var assessmentNote = {
                          caption: 'Previous Assessments notes:',
                          assessmentNoteList: []
                      };
                      data["assessmentNote"] = assessmentNote;
                    }

                    var textAssessmentNote = record[i]["TEXT1"].value;
                    assessmentNote.assessmentNoteList.push(textAssessmentNote);
                }
                else if (record[i]["ORDER1"].value == "280") { //assessment

                    if (!assessment)
                    {
                      var assessment = {
                          caption: 'Assessment for this encounter:',
                          assessmentList: []
                      };
                      data["assessment"] = assessment;
                    }

                    var textAssessment = record[i]["TEXT2"].value;
                    assessment.assessmentList.push(textAssessment);
                }
                else if (record[i]["ORDER1"].value == "285"){ //assessment Free Form
                  if (!assessmentFreeForm)
                  {
                    var assessmentFreeForm = {
                        caption: 'Diagnostic',
                        text: record[i]["TEXT1"].value

                    };
                    data["assessmentFreeForm"] = assessmentFreeForm;
                  }
                }
                else if (record[i]["ORDER1"].value == "310") { //procedure

                    if (!procedure)
                    {
                      var procedure = {
                          caption: 'Procedures:',
                          procedureList: []
                      };
                      data["procedure"] = procedure;
                    }

                    var textProcedure = record[i]["TEXT2"].value;
                    procedure.procedureList.push(textProcedure);

                }
                else if (record[i]["ORDER1"].value == "295") { //carePlan

                  if (!carePlan)
                  {
                    var carePlan = {
                        caption: 'Care Plan:',
                        carePlanList: []
                    };
                    data["carePlan"] = carePlan;
                  }

                  if(isOdd(record[i]["ORDER2"].value))
                  {
                    var objCarePlanList = {};
                    objCarePlanList["keyName"] = record[i]["TEXT2"].value;
                  }
                  else
                  {
                    objCarePlanList["value"] = record[i]["TEXT3"].value;
                    carePlan.carePlanList.push(objCarePlanList);
                  }

                }
                else if (record[i]["ORDER1"].value == "300") { //planFreeFormat
                  var keyPlanFreeFormat = record[i]["TAG"].value;
                  data[keyPlanFreeFormat] = record[i]["TEXT2"].value;
                }
                else if (record[i]["ORDER1"].value == "320") {//carePlanGoal

                  if (!carePlanGoal)
                  {
                    var carePlanGoal = {
                        caption: 'Care Plan Goals:',
                        carePlanGoalList: []
                    };
                    data["carePlanGoal"] = carePlanGoal;
                  }

                  if(isOdd(record[i]["ORDER2"].value))
                  {
                    var objCarePlanGoalList = {};
                    objCarePlanGoalList["keyName"] = record[i]["TEXT2"].value;
                  }
                  else
                  {
                    objCarePlanGoalList["value"] = record[i]["TEXT3"].value;
                    carePlanGoal.carePlanGoalList.push(objCarePlanGoalList);
                  }

                }
                else if (record[i]["ORDER1"].value == "330") {//labOrder

                    if (!labOrder)
                    {
                      var labOrder = {
                          caption: 'Lab Order(s):',
                          labOrderList: []
                      };
                      data["labOrder"] = labOrder;
                    }

                    var textLabOrder = record[i]["TEXT2"].value;
                    labOrder.labOrderList.push(textLabOrder);
                }
                else if (record[i]["ORDER1"].value == "350") { //patientReminder
                  var keyPatientReminder = record[i]["TAG"].value;
                  data[keyPatientReminder] = record[i]["TEXT2"].value;
                }
                else if (record[i]["ORDER1"].value == "355") {//order

                  if(!order)
                  {
                    var order = {
                      caption : 'Order(s)',
                      orderList : []
                    };
                    data["order"] = order;
                   }


                     var objOrder = {text1: '', text2: '', text3: ''};

                     if(record[i]["TEXT1"].value)
                     {
                       if(record[i]["TEXT1"].value.trim())
                       {
                         objOrder.text1 = record[i]["TEXT1"].value
                       }
                    }
                     else if(record[i]["TEXT2"].value)
                     {
                       if(record[i]["TEXT2"].value.trim())
                       {
                         objOrder.text2 = record[i]["TEXT2"].value;
                       }

                     }
                     else if(record[i]["TEXT3"].value)
                     {
                       if(record[i]["TEXT3"].value.trim())
                       {
                         objOrder.text3 = record[i]["TEXT3"].value;
                       }
                     }


                     order.orderList.push(objOrder);



                }
                else if (record[i]["ORDER1"].value == "390") {//rx

                    if(!rx)
                    {
                      var rx = {
                        caption : 'Medications prescribed during this visit:',
                        rxList : []
                      };
                      data["rx"] = rx;
                    }

                    var textRx = record[i]["TEXT2"].value;
                    rx.rxList.push(textRx);
                }
                else if(record[i]["ORDER1"].value == "255") {//Mental Status

                  if (!mentalStatus)
                  {
                    var mentalStatus = {
                        caption: 'Mental Status:',
                        mentalStatusList: []
                    };
                    data["mentalStatus"] = mentalStatus;
                  }

                  if(isOdd(record[i]["ORDER2"].value))
                  {
                    var objMentalStatusList = {};
                    objMentalStatusList["keyName"] = record[i]["TEXT2"].value;
                  }
                  else
                  {
                    objMentalStatusList["value"] = record[i]["TEXT3"].value;
                    mentalStatus.mentalStatusList.push(objMentalStatusList);
                  }
                }
                else if(record[i]["ORDER1"].value == "400") {//generalInstruction
                      if(!generalInstruction)
                      {
                        var generalInstruction = {
                          caption : '',
                          generalInstructionList : []
                        };
                        data["generalInstruction"] = generalInstruction;
                      }

                      if(record[i]["TEXT1"].value)
                      {
                        generalInstruction.caption = record[i]["TEXT1"].value;
                      }
                      else
                      {
                        var textGeneralInstruction = record[i]["TEXT2"].value;
                        generalInstruction.generalInstructionList.push(textGeneralInstruction);
                      }
                }
                else if(record[i]["ORDER1"].value == "410") {//woundCare

                    if(!woundCare)
                    {
                      var woundCare = {
                        caption : '',
                        woundCareList : []
                      };
                      data["woundCare"] = woundCare;
                    }

                    if(record[i]["TEXT1"].value)
                    {
                      woundCare.caption = record[i]["TEXT1"].value;
                    }
                    else
                    {
                      var textWoundCare = record[i]["TEXT2"].value;
                      woundCare.woundCareList.push(textWoundCare);
                    }
                }
                else if(record[i]["ORDER1"].value == "430") { //vaccination

                    if (!vaccination)
                    {
                      var vaccination = {
                          caption: 'Vaccination(s) for this visit:',
                          vaccinationList: []
                      };
                      data["vaccination"] = vaccination;
                    }


                    var textVaccination= record[i]["TEXT2"].value;
                    vaccination.vaccinationList.push(textVaccination);


                }
                else if (record[i]["TAG"].value == "logo") {//Logo

                  if (record[i]["IMAGE"].value) {

                    // var blobinfo = require("blobinfo");
                    // var buffer = new Buffer(record[i]["IMAGE"].value);
                    // console.log(blobinfo.inspect(buffer));

                    var logoSrc =  decodeArrayBuffer(record[i]["IMAGE"].value);
                    data["logoSrc"] = logoSrc;


                  }

                }
                else
                {
                  var key = record[i]["TAG"].value;
                  data[key] = record[i]["TEXT1"].value;
                }

            }


            //console.log(data);

            return data;
      }

      function isOdd(num) { return num % 2;}

      function formatKeyName(keyName)
      {
          //console.log(keyName);

          if(keyName == "FUVISIT30")
          {
              return "F/U Visit";
          }
          else if(keyName == "HPI40")
          {
              return "HPI";
          }
          else if(keyName == "HISTPASTMEDICAL50")
          {
              return "Medical History";
          }
          else if(keyName == "HISTSURGERY60")
          {
              return "Surgical History";
          }
          else if(keyName == "HEALTHMAINTENANCE70")
          {
              return "Health Maintenance";
          }
          else if(keyName == "HISTPEDIATRIC80")
          {
              return "Pediatric History";
          }
          else if(keyName == "PSYCHIATRICHISTORY90")
          {
              return "Psychiatric History";
          }
          else if(keyName == "VASCULARHISTORY100")
          {
              return "Vascular History";
          }
          else if(keyName == "HISTOB110")
          {
              return "Obstetrical History";
          }
          else if(keyName == "HISTALLERGIES120")
          {
              return "Allergies";
          }
          else if(keyName == "HISTMEDICATIONS130")
          {
              return "Medication History";
          }
          else if(keyName == "HISTSURGERY60")
          {
              return "Surgery History";
          }
          else if(keyName == "HISTFAMILY150")
          {
              return "Family History";
          }
          else if(keyName == "HISTSOCIAL160")
          {
              return "Social History";
          }
          else if(keyName == "REVIEWOFSYSTEMS170175")
          {
              return "Review of Systems";
          }
          else if(keyName == "VITALSIGNS190")
          {
              return "Vital Signs";
          }
          else if(keyName == "NARRATIVE200")
          {
              return "Narrative";
          }
          else if(keyName == "EXAMS210")
          {
              return "Exams";
          }
          else if(keyName == "IMAGES250")
          {
              return "Images";
          }
          else if(keyName == "SLITLAMP220")
          {
              return "Slit/Lamp";
          }
          else if(keyName == "EXAMREFRATION225")
          {
              return "Exam Refration";
          }
          else if(keyName == "EYEWORKUP230")
          {
              return "Eye Workup";
          }
          else if(keyName == "BIOPSY240")
          {
              return "Biopsy";
          }
          else if(keyName == "DIAGNOSTICSTUDIES260")
          {
              return "Diagnostic Studies";
          }
          else if(keyName == "ASSESSMENTNOTES270")
          {
              return "Assessment Notes";
          }
          else if(keyName == "ASSESSMENT280")
          {
              return "Assessment";
          }
          else if(keyName == "ASSESSMENTSFREEFORM285")
          {
              return "Assessments Free Form";
          }
          else if(keyName == "PROCEDURES310")
          {
              return "Procedures";
          }
          else if(keyName == "CAREPLAN295")
          {
              return "Care Plan";
          }
          else if(keyName == "PLANFREEFORMAT300")
          {
              return "Plan Free Format";
          }
          else if(keyName == "CAREPLANGOALS320")
          {
              return "Care Plan Goals";
          }
          else if(keyName == "LABORDERS330")
          {
              return "Lab Orders";
          }
          else if(keyName == "REFERRALTOPHYSICIAN340")
          {
              return "Referral To Physician";
          }
          else if(keyName == "REFERRALTOFACILITY345")
          {
              return "Referral To Facility";
          }
          else if(keyName == "PATIENTREMINDER350")
          {
              return "Patient Reminder";
          }
          else if(keyName == "ORDERS355")
          {
              return "Orders";
          }
          else if(keyName == "DECISIONAIDS380")
          {
              return "Decision Aids";
          }
          else if(keyName == "RXTHISVISIT390")
          {
              return "Rx This Visit";
          }
          else if(keyName == "MENTALSTATUS255")
          {
              return "Mental Status";
          }
          else if(keyName == "GENERALINSTRUCTIONS400")
          {
              return "General Instructions";
          }
          else if(keyName == "WOUNDCARE410")
          {
              return "Woundcare";
          }
          else if(keyName == "VACCINATION430")
          {
              return "Vaccination";
          }
          else
          {
              return keyName;
          }

      }


      function stringFormatedDate(datePara) {

        if(datePara)
        {
            var date = new Date(datePara);

            var month = date.getMonth() + 1;
            var dateD = date.getDate();
            var year = date.getFullYear();

          return  month +"/"+ dateD +"/"+ year;

        }
        else
        {
          var date = new Date();

          var month = date.getMonth() + 1;
          var dateD = date.getDate();
          var year = date.getFullYear();

          return  month +"/"+ dateD +"/"+ year;

        }



      }

      function stringDateTimeUniqueNumber() {

          var date = new Date();

          var month = date.getMonth() + 1;
          var dateD = date.getDate();
          var year = date.getFullYear();
          var hours = date.getHours();
          var minutes = date.getMinutes();
          var seconds = date.getSeconds();
          return  month +""+ dateD +""+ year +""+ hours +""+ minutes +""+ seconds;
      }

      function decodeArrayBuffer(buffer) {
          var mime;
          var a = new Uint8Array(buffer);
          var nb = a.length;
          if (nb < 4)
              return null;
          var b0 = a[0];
          var b1 = a[1];
          var b2 = a[2];
          var b3 = a[3];
          if (b0 == 0x89 && b1 == 0x50 && b2 == 0x4E && b3 == 0x47)
              mime = 'image/png';
          else if (b0 == 0xff && b1 == 0xd8)
              mime = 'image/jpeg';
          else if (b0 == 0x47 && b1 == 0x49 && b2 == 0x46)
              mime = 'image/gif';

          //0x42 BMP
          else if(b0 == 0x42)
              mime = 'image/bmp';
          else
              return null;
          var binary = "";
          for (var i = 0; i < nb; i++)
              binary += String.fromCharCode(a[i]);
          var base64 = window.btoa(binary);
          var image = new Image();

          image.src = 'data:' + mime + ';base64,' + base64;
          return image.src;
        }





    </script>

</body>
</html>
